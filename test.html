<!DOCTYPE html>
<html>
<head lang="en">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>FastMap API</title>
    <link href="js/lib/leaflet-0.7.3/leaflet.css" rel="stylesheet" type="text/css" />
    <script src="js/lib/leaflet-0.7.3/leaflet-src.js"></script>
    <script src="js/fastmap/fastmapapi.js"></script>
    <script src="js/lib/jquery/jquery-1.11.1.js"></script>
</head>
<body>
<div id="mapId" style="width:1000px;height:500px">

</div>
<input type="button" id="btn_insert" value="插入节点"></input>
<input type="button" id="btn_move" value="移动节点"></input>
<input type="button" id="btn_delete" value="删除节点"></input>
<input type="button" id="btn_extend" value="延长线"></input>
<input type="button" id="btn_enable" value="结束编辑"></input>
<input type="button" id="btn_abort" value="放弃编辑"></input>
</body>
<script>
    var map = L.map('mapId').setView([39.907333, 116.391083], 14);

//    L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6IjZjNmRjNzk3ZmE2MTcwOTEwMGY0MzU3YjUzOWFmNWZhIn0.Y8bhBaUMqFiPrDRW9hieoQ', {
//        maxZoom: 18,
//        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
//        '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
//        'Imagery © <a href="http://mapbox.com">Mapbox</a>',
//        id: 'mapbox.streets'
//    }).addTo(map);
    L.tileLayer('http://{s}.map.gtimg.com/realtimerender?z={z}&x={x}&y={y}&type=vector&style=0', {
        subdomains: ["rt0", "rt1", "rt2", "rt3"],
        tms: true,
        maxZoom: 18
    }).addTo(map);

//    var l = fastmap.mapApi.meshLayer();
//    map.addLayer(l)
//
//    var c = l.canv;
//    var ctx = c.getContext('2d');
//    ctx.translate(200,200)
//    ctx.beginPath();
//    ctx.fillStyle = 'red'
//    ctx.moveTo(0,4)
//    ctx.quadraticCurveTo(6,-3,12,4);
//    ctx.lineTo(6,12);
//    ctx.lineTo(0,4);
//    ctx.closePath();
//    ctx.strokeStyle = 'red';
//    ctx.fill();
//
//    ctx.stroke();

    var editLayer = new  fastmap.mapApi.EditLayer();
    map.addLayer(editLayer);

//    var latlngs = [[39.907333, 116.391083],[39.909333, 116.394083]];
//    var polyline = L.polyline(latlngs, {color: 'red'}).addTo(map);
//    var p = map.project(new L.LatLng(39.909333, 116.394083));


    var line = fastmap.mapApi.lineString([fastmap.mapApi.point(116.391083,39.907333),fastmap.mapApi.point(116.394083,39.909333),fastmap.mapApi.point(116.391083,39.902333),fastmap.mapApi.point(116.396083,39.902933)]);
    var line2 = fastmap.mapApi.lineString([fastmap.mapApi.point(116.391083,39.907333),fastmap.mapApi.point(116.394083,39.909333),fastmap.mapApi.point(116.391083,39.902333),fastmap.mapApi.point(116.396083,39.902933)]);

    console.log(line ===line2)
    editLayer.drawGeometry = line;
    editLayer.draw(line,editLayer);

//    var tileJson = new fastmap.mapApi.TileJSON({
//        id:'ee',
//        url:'http://192.168.1.111:8080/FosEngineWeb/pdh/obj/getByTileWithGap?',
//        hitDetection: true,
//        debug: false,
//        // this value should be equal to 'radius' of your points
//        buffer: 10,
//        boolPixelCrs: true ,
//        parse: parseLineStringData,
//        boundsArr: [],
//        unloadInvisibleTiles: true,
//        reuseTiles: false,
//        mecator:new fastmap.mapApi.MecatorTranform(),
//        updateWhenIdle: true,
//        tileSize:256,
//        type: 'LineString',
//
//        restrictZoom:10
//    }).addTo(map);

    function parseLineStringData(data) {
        var geojson = {};
        geojson['features'] = [];
        $.each(data.data.RDLINK, function (index, item) {
            var obj = {};
            obj['type'] = "Feature";
            obj['geometry'] = {};
            obj['geometry']['type'] = 'LineString';
            obj['geometry']['coordinates'] = [];
            for (var i = 0, len = item.g.length; i < len; i = i+1) {
                obj['geometry']['coordinates'].push([item.g[i]]);
            }
            obj['properties'] = {
                'id': item.i,
                'color': item.s
            }
            geojson['features'].push(obj);
        });
        return geojson;
    }
    $('#btn_insert').click(
            function(){
                var shapectl = fastmap.uikit.ShapeEditorController();
                shapectl.setMap(map);
                shapectl.setEditingType('pathVertexInsert');
                var sobj = new fastmap.uikit.ShapeEditorResult();
                sobj.setOriginalGeometry(line2);
                sobj.setFinalGeometry(line);
                shapectl.startEditing(sobj);
            }
    );

    $('#btn_enable').click(function(){
        fastmap.uikit.ShapeEditorController().stopEditing();
    })

    $('#btn_abort').click(function(){
        fastmap.uikit.ShapeEditorController().abortEditing();
    })


    $('#btn_move').click(function(){
        var shapectl1 = fastmap.uikit.ShapeEditorController();
        shapectl1.setMap(map);
        shapectl1.setEditingType('pathVertexMove');
        var sobj = new fastmap.uikit.ShapeEditorResult();
        sobj.setOriginalGeometry(line2);
        sobj.setFinalGeometry(line);
        shapectl1.startEditing(sobj);
    });

    $("#btn_delete").click(function(){
        var shapectl2 = fastmap.uikit.ShapeEditorController();
        shapectl2.setMap(map);
        shapectl2.setEditingType('pathVertexReMove');
        var sobj = new fastmap.uikit.ShapeEditorResult();
        sobj.setOriginalGeometry(line2);
        sobj.setFinalGeometry(line);
        shapectl2.startEditing(sobj);

    })

    $('#btn_extend').click(function(){
        var shapectl3 = fastmap.uikit.ShapeEditorController();
        shapectl3.setMap(map);
        shapectl3.setEditingType('pathVertexAdd');
        var sobj = new fastmap.uikit.ShapeEditorResult();
        sobj.setOriginalGeometry(line2);
        sobj.setFinalGeometry(line);
        shapectl3.startEditing(sobj);

    })
</script>

</html>

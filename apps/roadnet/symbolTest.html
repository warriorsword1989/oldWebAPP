<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SymbolTest</title>
    <link rel="stylesheet" type="text/css" href="../../scripts/libs/sweet-alert/css/sweet-alert.css">
    <style type="text/css">
        body {
            position: relative;
        }

        #container {
            width: 100%;
            height: 100%;
            margin: 0;
            border: 1px solid gray;
            position: absolute;
        }

        #menuBar, #ListView {
            width: 100%;
            height: 20px;
            margin: 0;
        }

        #searchBar {
            width: 100%;
            height: auto;
            margin: 0;
        }

        .item_container {
            margin: 3px;
            border: 1px solid #bebebe;
            height: auto;
            width: auto;
            display: inline-block;
            text-align: center;
        }

        .item_container:hover {
            border: 1px solid #333333;
        }

        .item_title {
            text-align: center;
            font-weight: normal;
            width: 100%;
            font-size: 12px;
            margin: 10px 0 10px 0;
        }

        .item_canvas {
            margin: 3px;
            border: 1px solid #bebebe;
        }
    </style>
</head>
<body>
<div id="container">
    <div id="menuBar">
        <button onclick="onAdd()">新增</button>
        <button onclick="onModify()">修改</button>
        <button onclick="onRemove()">删除</button>
    </div>
    <div id="searchBar">
        <input id="searchSymbolName" oninput="onSearchInput()" type="text">
        <button>查找</button>
    </div>
    <div id="ListView">
    </div>
</div>
</body>
<script src="../../scripts/libs/jquery/2.1.1/jquery-2.1.1.js"></script>
<script src="../../scripts/libs/leaflet-0.7.3/leaflet-src.js"></script>
<script src="../../scripts/libs/sweet-alert/js/sweet-alert.js"></script>
<script src="../../scripts/mapApi/fastmap.js"></script>
<script src="../../scripts/mapApi/symbol/Matrix.js"></script>
<script src="../../scripts/mapApi/symbol/Vector.js"></script>
<script src="../../scripts/mapApi/symbol/Point.js"></script>
<script src="../../scripts/mapApi/symbol/LineSegment.js"></script>
<script src="../../scripts/mapApi/symbol/LineString.js"></script>
<script src="../../scripts/mapApi/symbol/Template.js"></script>
<script src="../../scripts/mapApi/symbol/CirclePointSymbol.js"></script>
<script src="../../scripts/mapApi/symbol/SolidCirclePointSymbol.js"></script>
<script src="../../scripts/mapApi/symbol/SquarePointSymbol.js"></script>
<script src="../../scripts/mapApi/symbol/SolidSquarePointSymbol.js"></script>
<script src="../../scripts/mapApi/symbol/CrossPointSymbol.js"></script>
<script src="../../scripts/mapApi/symbol/TiltedCrossPointSymbol.js"></script>
<script src="../../scripts/mapApi/symbol/PicturePointSymbol.js"></script>
<script src="../../scripts/mapApi/symbol/CompositePointSymbol.js"></script>
<script src="../../scripts/mapApi/symbol/SampleLineSymbol.js"></script>
<script src="../../scripts/mapApi/symbol/HashLineSymbol.js"></script>
<script src="../../scripts/mapApi/symbol/CartoLineSymbol.js"></script>
<script src="../../scripts/mapApi/symbol/MarkerLineSymbol.js"></script>
<script src="../../scripts/mapApi/symbol/CompositeLineSymbol.js"></script>
<script src="../../scripts/mapApi/symbol/SymbolFactory.js"></script>
<script src="../../scripts/mapApi/symbol/SymbolsFile.js"></script>

<script>
    var canvasSize = 100;
    var pointGeometry = new fastmap.mapApi.symbol.Point(canvasSize / 2, canvasSize / 2);
    var lineGeometry = new fastmap.mapApi.symbol.LineString([[0, 0], [canvasSize, canvasSize]]);
    var symbolFactory = fastmap.mapApi.symbol.GetSymbolFactory();

    var selectedSymbolName = null;
    $(document).ready(function () {
        loadSymbolsFile();

        var symbolNames = symbolFactory.getSymbolNames();
        createSymbolItems(symbolNames);
    });

    function loadSymbolsFile() {
        for (var i = 0; i < fastmap.mapApi.symbol.symbols.length; ++i) {
            var data = fastmap.mapApi.symbol.symbols[i];
            symbolFactory.addSymbol(data.name, createSymbol(data));
        }
    }

    function createSymbol(data) {
        var type = data.type;
        var symbol = symbolFactory.createSymbol(type);
        switch (type) {
            case 'CirclePointSymbol':
                symbol.radius = data.radius;
                symbol.color = data.color;
                symbol.width = data.width;
                symbol.offsetX = data.offsetX;
                symbol.offsetY = data.offsetY;
                break;
            case 'SolidCirclePointSymbol':
                symbol.radius = data.radius;
                symbol.color = data.color;
                symbol.offsetX = data.offsetX;
                symbol.offsetY = data.offsetY;
                symbol.hasOutLine = data.hasOutLine;
                symbol.outLineColor = data.color;
                symbol.outLineWidth = data.width;
                break;
            case 'SquarePointSymbol':
                symbol.size = data.size;
                symbol.color = data.color;
                symbol.width = data.width;
                symbol.angle = data.angle;
                symbol.offsetX = data.offsetX;
                symbol.offsetY = data.offsetY;
                break;
            case 'SolidSquarePointSymbol':
                symbol.size = data.size;
                symbol.color = data.color;
                symbol.angle = data.angle;
                symbol.offsetX = data.offsetX;
                symbol.offsetY = data.offsetY;
                symbol.hasOutLine = data.hasOutLine;
                symbol.outLineColor = data.color;
                symbol.outLineWidth = data.width;
                break;
            case 'CrossPointSymbol':
                symbol.size = data.size;
                symbol.color = data.color;
                symbol.width = data.width;
                symbol.angle = data.angle;
                symbol.offsetX = data.offsetX;
                symbol.offsetY = data.offsetY;
                symbol.hasOutLine = data.hasOutLine;
                symbol.outLineColor = data.color;
                symbol.outLineWidth = data.width;
                break;
            case 'TiltedCrossPointSymbol':
                symbol.size = data.size;
                symbol.color = data.color;
                symbol.width = data.width;
                symbol.angle = data.angle;
                symbol.offsetX = data.offsetX;
                symbol.offsetY = data.offsetY;
                symbol.hasOutLine = data.hasOutLine;
                symbol.outLineColor = data.color;
                symbol.outLineWidth = data.width;
                break;
            case 'PicturePointSymbol':
                symbol.url = data.url;
                symbol.size = data.size;
                symbol.angle = data.angle;
                symbol.offsetX = data.offsetX;
                symbol.offsetY = data.offsetY;
                symbol.hasOutLine = data.hasOutLine;
                symbol.outLineColor = data.color;
                symbol.outLineWidth = data.width;
                break;
            case 'CompositePointSymbol':
                for (var i = 0; i < data.symbols.length; ++i) {
                    symbol.symbols.push(createSymbol(data.symbols[i]));
                }
                break;
            case 'SampleLineSymbol':
                symbol.color = data.color;
                symbol.width = data.width;
                symbol.style = data.style;
                break;
            case 'CartoLineSymbol':
                symbol.color = data.color;
                symbol.width = data.width;
                symbol.template.pattern = data.pattern;
                break;
            case 'MarkerLineSymbol':
                symbol.color = data.color;
                symbol.width = data.width;
                symbol.markerSymbol = createSymbol(data.symbol);
                symbol.template.pattern = data.pattern;
                break;
            case 'HashLineSymbol':
                symbol.hashHeight = data.hashHeight;
                symbol.hashOffset = data.hashOffset;
                symbol.hashAngle = data.hashAngle;
                symbol.hashSymbol = createSymbol(data.hashSymbol);
                symbol.template.pattern = data.pattern;
                break;
            case 'CompositeLineSymbol':
                for (var i = 0; i < data.symbols.length; ++i) {
                    symbol.symbols.push(createSymbol(data.symbols[i]));
                }
                break;
            default:
                throw new Error('不支持的符号类型: ' + type);
        }

        return symbol;
    }

    function createSymbolItems(symbolNames) {
        for (var i = 0; i < symbolNames.length; ++i) {
            var symbolItem = createSymbolItem(symbolNames[i]);
            $('#ListView').append(symbolItem);
        }
    }

    function createSymbolItem(symbolName) {
        var itemContainer = document.createElement("div");
        $(itemContainer).attr('class', 'item_container');
        $(itemContainer).on('click', function () {
            selectedSymbolName = symbolName;
            refreshSelectedItemStatus();
        });
        var title = document.createElement("div");
        $(title).attr('class', 'item_title');
        $(title).text(symbolName);
        itemContainer.appendChild(title);
        var canvas = document.createElement("canvas");
        $(canvas).attr('class', 'item_canvas');
        $(canvas).attr('width', canvasSize);
        $(canvas).attr('height', canvasSize);
        itemContainer.appendChild(canvas);

        var symbol = symbolFactory.getSymbol(symbolName);
        if (symbol.type.match('PointSymbol')) {
            symbol.geometry = pointGeometry;
        } else {
            symbol.geometry = lineGeometry;
        }
        symbol.draw(canvas.getContext('2d'));

        return itemContainer;
    }

    function refreshSelectedItemStatus() {
        var selectedItem = '.item_title';
        var divs = $(selectedItem);
        for (var i = 0; i < divs.length; ++i) {
            if (divs[i].innerText === selectedSymbolName) {
                $(divs[i]).css('background', 'green');
            } else {
                $(divs[i]).css('background', 'none');
            }
        }
    }

    function refreshListView() {
        var symbolName = $('#searchSymbolName').val();

        var matchSymbolNames = [];
        var symbolNames = symbolFactory.getSymbolNames();
        for (var i = 0; i < symbolNames.length; ++i) {
            if (symbolNames[i].match(symbolName)) {
                matchSymbolNames.push(symbolNames[i]);
            }
        }

        $('#ListView').empty();
        createSymbolItems(matchSymbolNames);
    }

    function onSearchInput() {
        refreshListView();
    }

    function onRemove() {
        if (selectedSymbolName === null) {
            swal({
                title: "信息",
                text: "没有选中符号",
                type: "info",
                closeOnConfirm: false,
                confirmButtonText: "确定",
                confirmButtonColor: "#ec6c62"
            });

            return;
        }

        swal({
            title: "删除确认",
            text: "您确定要删除这个符号？",
            type: "warning",
            showCancelButton: true,
            closeOnConfirm: false,
            cancelButtonText: "先留着",
            confirmButtonText: "是的，我要删除",
            confirmButtonColor: "#ec6c62"
        }, function () {
            symbolFactory.removeSymbol(selectedSymbolName);

            refreshListView();
        });
    }

    function onAdd() {
        showDialog();
    }
</script>
</html>